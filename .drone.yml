  
kind: pipeline
name: Drone

workspace:
  path: /drone/src

steps:
 - name: compile
   image: apon77/aosp:latest
   environment:
     bottoken:
       from_secret: bottoken
     chatid:
       from_secret: chatid
     repo1:
       from_secret: repo1
   
   commands:
      - sudo chown -R ci ./
      - sudo apt install bc
      - git clone --depth=1 $repo1 -b daisy msm8953 && cd msm8953
      - git clone --depth=1 --single-branch https://github.com/mvaisakh/gcc-arm64.git gcc-arm64
      - git clone --depth=1 --single-branch https://github.com/mvaisakh/gcc-arm.git gcc-arm
      - export BUILD_START=$(date +"%s")
      - export CROSS_COMPILE="$(pwd)/gcc-arm64/bin/aarch64-elf-"
      - export CROSS_COMPILE_ARM32="$(pwd)/gcc-arm/bin/arm-eabi-"
      - export ARCH=arm64
      - make O=out daisy_defconfig
      - make O=out -j"$(nproc --all)"
      - export BUILD_END=$(date +"%s")
      - export DIFF=$((BUILD_END - BUILD_START))
      - git clone https://github.com/sarthakroy2002/AnyKernel3 AnyKernel3
      - cp out/arch/arm64/boot/Image.gz-dtb AnyKernel3 && cd AnyKernel3
      - export ZIPNAME=Hyouka-Kernel-$(TZ=Asia/Dhaka date +%Y%m%d-%H%M).zip
      - zip -r9 $ZIPNAME ./*
      - curl -F document=@"$ZIPNAME" "https://api.telegram.org/bot$bottoken/sendDocument" -F chat_id="$chatid" -F "parse_mode=Markdown" -F caption="*âœ… Build finished after $((DIFF / 60)) minute(s) and $((DIFF % 60)) seconds*"

trigger:
  branch:
  - master
  event:
  - push
