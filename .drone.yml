  
kind: pipeline
name: Drone

workspace:
  path: /drone/src

steps:
 - name: compile
   image: apon77/aosp:latest
   environment:
     bottoken:
       from_secret: bottoken
     chatid:
       from_secret: chatid
     repo1:
       from_secret: repo1
   
   commands:
      - sudo chown -R ci ./
      - git clone --depth=1 $repo1 -b daisy msm8953 && cd msm8953
      - git clone --depth=1 --single-branch https://github.com/kdrag0n/proton-clang.git -b master clang
      - export BUILD_START=$(date +"%s")
      - make daisy_defconfig
      - make -j16 O=out ARCH=arm64 CC=clang CROSS_COMPILE=aarch64-linux-gnu- CROSS_COMPILE_ARM32=arm-linux-gnueabi-
      - export BUILD_END=$(date +"%s")
      - export DIFF=$((BUILD_END - BUILD_START))
      - git clone https://github.com/sarthakroy2002/AnyKernel3 AnyKernel3
      - cp out/arch/arm64/boot/Image.gz-dtb AnyKernel3 && cd AnyKernel3
      - export ZIPNAME=Hyouka-Kernel-$(TZ=Asia/Dhaka date +%Y%m%d-%H%M).zip
      - zip -r9 $ZIPNAME ./*
      - curl -F document=@"$ZIPNAME" "https://api.telegram.org/bot$bottoken/sendDocument" -F chat_id="$chatid" -F "parse_mode=Markdown" -F caption="*âœ… Build finished after $((DIFF / 60)) minute(s) and $((DIFF % 60)) seconds*"

trigger:
  branch:
  - master
  event:
  - push
